import { Router } from 'express'; import Cart from '../models/Cart.js'; import Order from '../models/Order.js'; import Product from '../models/Product.js'; import { requireAuth } from '../rbac/guards.js';
const r=Router();
r.post('/orders', requireAuth, async (req,res)=>{ const cart=await Cart.findOne({user:req.user._id}).lean(); if(!cart||!cart.items?.length) return res.status(400).json({ok:false,error:'cart empty'}); const ids=cart.items.map(i=>i.product); const prods=await Product.find({_id:{$in:ids}}).lean(); const map=Object.fromEntries(prods.map(p=>[String(p._id),p])); const items=cart.items.map(i=>{ const p=map[String(i.product)]; const unitPrice=p?.price||0; const lineTotal=unitPrice*i.qty; return {product:i.product,firm:p?.firm,qty:i.qty,unitPrice,currency:p?.currency||'INR',lineTotal}; }); const subtotal=items.reduce((s,i)=>s+i.lineTotal,0); const discount=0,tax=0; const grand=subtotal-discount+tax; const ord=await Order.create({ user:req.user._id, items, amounts:{subtotal,discount,tax,grand}, status:'created' }); res.json({ok:true,order:ord}); });
export default r;
